<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body onload="qweqwe()">
  <textarea rows="4" cols="50" id="asd" placeholder="貼上原版腳本" onchange="qweqwe()"></textarea>
  <pre id="whereToPrint"></pre>
  <script>


    function qweqwe() {
      var asd = document.getElementById('whereToPrint');
      asd.innerHTML = "";

      var str = document.getElementById('asd').value;

      var eee = str.replace(/\n/g, '').replace(/<frame>/g, 'qqq:').replace(/<frame_end>/g, 'www:');

      var ddd = eee.split(" ");
      var dd = false;
      var ss = false;
      var skillname = '';
      var eeeqwe = 0;

      for (let i = 0; i < ddd.length; i++) {
        const element = ddd[i];
        const array = ddd;

        if (i == 2) {
          skillname = ddd[i];
          if (eeeqwe > 0) array[i] = skillname + eeeqwe + ':{';
          else array[i] = skillname  + ':{';

          eeeqwe++;
        }

        // 忽略
        if (
          element.indexOf('state') >= 0
          || element.indexOf('sound') >= 0
          || element.indexOf('kind') >= 0
          || element.indexOf('dvz') >= 0
          || element.indexOf('fall:') >= 0
          || element.indexOf('rest') >= 0
          || element.indexOf('bdefend') >= 0
          || element.indexOf('effect') >= 0
          || element.indexOf('hit_') >= 0
          || element.indexOf('mp') >= 0
          || element.indexOf('facing') >= 0
          || element.indexOf('qqq') >= 0
          || element.indexOf('\n') >= 0

        ) {
          array[i] = '';
          array[i + 1] = '';
        };
        console.log(element);

        if (
          element.indexOf('www') >= 0
        ) {
          // array[i-1] = '';
          array[i] = '},';
        };

        // 忽略
        if (
          element.indexOf('catchingact') >= 0
          || element.indexOf('caughtact') >= 0

          || element.indexOf('caughtact') >= 0
        ) {
          array[i] = '';
          array[i + 1] = '';
          array[i + 2] = '';
        };

        // 忽略
        if (element == 'wpoint:') ss = true;
        if (ss) array[i] = '';
        if (element == 'wpoint_end:') ss = false;

        if (element == 'bpoint:') ss = true;
        if (ss) array[i] = '';
        if (element == 'bpoint_end:') ss = false;

        if (!ss) {

          // 需要
          if (
            element == 'wait:'
            || element == 'next:'
            || element == 'injury:'
            || element == 'y:'
            || element == 'w:'
            || element == 'h:'
          ) {
            // 如果沒有dvy 補上,0]
            if (dd) {
              dd = false;
              array.splice(i, 1, ',0], ' + element);
            }
            // 前面補逗點
            else if (element == 'next:') array.splice(i, 2, ",next: '" + skillname +eeeqwe+ "'");
            // 前面補逗點
            else array.splice(i, 1, ',' + element);
          }

          // 圖片
          if (element == 'pic:') {
            var n = array[i + 1];
            var a = Math.floor(n / 70);
            var b = Math.floor((n - (a * 70)) / 10);
            var c = (n % 10);
            array.splice(i, 3, `\n  pic: ['${a}' ,${b} ,${c}]`);
          }

          // 移動
          if (element == 'dvx:') {
            array.splice(i, 2, ',move:[' + array[i + 1]);
            dd = true;
          }
          else if (element == 'dvy:') {
            array.splice(i, 2, ',' + array[i + 1] + ']');
            dd = false;
          }

          // 座標
          if (element == 'centerx:') array.splice(i, 2, ',center:[' + array[i + 1]);
          else if (element == 'centery:') array.splice(i, 2, ',' + array[i + 1] + '],');



          // 大標籤轉換
          if (element == 'itr:') array.splice(i, 1, '\n  itr: {');
          else if (element == 'itr_end:') array.splice(i, 1, '},');
          else if (element == 'itr_end:www:') array.splice(i, 1, '},\n},');

          if (element == 'opoint:') array.splice(i, 1, '\nproduce: {');
          else if (element == 'opoint_end:') array.splice(i, 1, '},');


          // 替換
          if (element == 'action:') array[i] = ',name:';
          if (element == 'oid:') array[i] = ',frame:';

          if (element == 'bdy:') array.splice(i, 1, '\n  bdy: {');
          else if (element == 'bdy_end:') array.splice(i, 1, '},\n');
          else if (element == 'bdy_end:www:') array.splice(i, 1, '},\n},');

        }


      }

      var eeeeeeeeeee = '';
      for (let i = 0; i < ddd.length; i++) {
        // console.log(ddd[i]);
        if (ddd[i] != '') eeeeeeeeeee += ddd[i] + ' ';
        if (i == ddd.length - 1 && ddd[i] == '') eeeeeeeeeee += '\n},';
      }


      eeeeeeeeeee = eeeeeeeeeee.replace(/ ,/g, ', ');
      document.getElementById("whereToPrint").innerHTML = eeeeeeeeeee;
    }
  </script>
</body>

</html>