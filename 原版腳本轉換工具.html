<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>原版腳本轉換工具</title>
  <style>
    textarea {
      width: 99%;
    }
  </style>
</head>

<body onload="scriptConversion()">
  <textarea rows="6" id="originalScript" placeholder="貼上原版腳本" onchange="scriptConversion()"
    onfocus="(e => {e.value='';})(this)"></textarea>
  <pre id="newScript"></pre>
  <script>

    // 圖片row幾格
    var picrow = 10;
    var characterName = 'Louis';

    // FIXME: 出版前要在包裝一下 例如參數設定欄 複製提示等

    var ignoreLock;
    var skillname;
    var frameIndex;
    var array;
    var i;
    var element;

    function scriptConversion() {

      var str = document.getElementById('originalScript').value;
      array = str.replace(/\n/g, '').replace(/<frame_end>/g, ' <frame_end> ').split(" ");

      frameIndex = 1;

      for (i = 0; i < array.length; i++) {
        element = array[i];

        // console.log(element);
        // 開頭
        if (element == '<frame>') {
          // 傳給next用
          skillname = array[i + 2];

          // 第一個不用序號
          array[i] = '';
          array[i + 1] = "'";
          array[i + 2] += (frameIndex != 1 ? frameIndex : '') + "': {";
          frameIndex++;
        }

        // 忽略標籤
        tagsIgnore([
          'wpoint',
          'bpoint',
        ]);

        // 保留標籤
        tagsReserved([
          'itr',
          'opoint',
          'cpoint',
          'bdy',
        ]);

        // 忽略屬性
        attributeIgnore([
          'state',
          'dvz',
          'kind',
          'bdefend',
          'effect',
          'hit_',
          'mp:',
          'facing',
          'cover',
          '\n',
        ], 2);

        // 忽略屬性
        attributeIgnore([
          'catchingact',
          'caughtact',
          'throwvz:',
          'throwinjury:',
          'dircontrol:',
          'decrease:',
        ], 3);

        // 保留屬性
        attributeRetention([
          'pic:',
          'sound:',
          'wait:',
          'next:',
          'fall:',
          'vrest:',
          'arest:',
          'injury:',
          'x:',
          'y:',
          'w:',
          'h:',
        ]);

        // 座標類合併 (不另寫保留)
        attributeMerge('move', 'dvx', 'dvy');
        attributeMerge('center', 'centerx', 'centery');
        attributeMerge('move', 'throwvx', 'throwvy');

        // 替換屬性
        changename('action:', 'name:', characterName);
        changename('oid:', 'frame:', 'standing');
        changename('vaction:', 'frame:', '');



      }

      // 印出
      document.getElementById("newScript").innerText = '';
      for (let i = 0; i < array.length; i++) {
        if (array[i] != '' && array[i] != ' ') document.getElementById("newScript").innerText += array[i];
      }

      // 自動複製新腳本
      copyText("newScript");
    }

    // =====================================================================
    // API
    // =====================================================================

    // 複製新腳本
    function copyText(element) {
      var text = document.getElementById(element);
      var selection = window.getSelection();
      var range = document.createRange();
      range.selectNodeContents(text);
      selection.removeAllRanges();
      selection.addRange(range);
      document.execCommand('copy');
    }

    // 忽略標籤
    function tagsIgnore(list) {
      list.forEach(abname => {
        if (element == abname + ':') ignoreLock = true;
        if (ignoreLock) array[i] = '';
        if (element == abname + '_end:') ignoreLock = false;
        else if (element == '<frame_end>') {
          ignoreLock = false;
          array[i] = '\n},\n';
        }
      });
    }

    // 保留標籤
    function tagsReserved(list) {
      list.forEach(abname => {
        if (element == abname + ':')
          array[i] = '\n  ' + abname + ': { ';
        else if (element == abname + '_end:')
          array[i] = '},';
        else if (element == '<frame_end>')
          array[i] = '\n},\n';
      });
    }

    // 忽略屬性
    function attributeIgnore(list, sptime) {
      list.forEach(abname => {
        if (element.indexOf(abname) >= 0) {
          for (let j = 0; j < sptime; j++)
            // note: dircontrol, decrease不對齊特規
            if (array[i + j] != 'dircontrol:' && array[i + j] != 'decrease:') array[i + j] = '';
            else if (abname == 'dircontrol:' || abname == 'decrease:') array[i] = '';
        }
      });
    }

    // 保留屬性
    function attributeRetention(list) {

      if (element == 'pic:') {
        var n = array[i + 1];
        var filename = Math.floor(n / 70);
        var col = Math.floor((n - (filename * 70)) / picrow);
        var row = (n % picrow);

        array[i] = `\n  pic:`;
        array[i + 1] = `['${filename}', ${col}, ${row}]`;
      }

      else if (element == 'next:') {
        if (array[i + 1] != 999 && array[i + 1] != -999 && array[i + 1] != 1000 && array[i + 1] != 0) array[i + 1] = "'" + skillname + frameIndex + "'";
      }

      else if (element == 'fall:') {
        array[i + 1] = (array[i + 1] == 70);
      }

      else if (element == 'sound:') {
        array[i + 1] = "'" + array[i + 1].replace(/data\\/g, '') + "'";
      }

      else if (element == 'injury:' && array[i + 1] < 0) {
        array[i + 1] = array[i + 1] * -1;
      }

      // else if (element == 'throwvz:' || element == 'throwinjury:') {
      //   array[i + 1] = array[i + 1] * -1;
      // }

      // 後面補逗點
      list.forEach(abname => {
        if (element == abname) {
          array[i] += ' ';
          array[i + 1] += ', ';
        }
      });
    }

    // 更換屬性
    function changename(name1, name2, val) {
      if (element == name1) {
        array[i] = name2 + ' ';
        array[i + 1] = "'" + val + "', "
      }
    }

    // 座標合併
    function attributeMerge(n1, n2, n3) {

      if (ignoreLock) return;

      if (element == n2 + ':') {
        array[i] = n1 + ': ';
        array[i + 1] = '[' + array[i + 1] + ', ';

        // 如果沒有第二座標 補上0
        if (array[i + 3] != n3 + ':') array[i + 1] += '0], ';
      }
      else if (element == n3 + ':') {
        array[i] = '';
        array[i + 1] = array[i + 1] + '], ';
      }
    }

  </script>
</body>

</html>