<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body onload="qweqwe()">
  <textarea rows="4" cols="50" id="asd" placeholder="貼上原版腳本" onchange="qweqwe()"></textarea>
  <pre id="whereToPrint"></pre>
  <script>
    var ss = false;
    var skillname = '';
    var frameIndex = 1;

    function qweqwe() {
      var asd = document.getElementById('whereToPrint');
      asd.innerHTML = "";

      // 前置
      var str = document.getElementById('asd').value;
      var eee = str.replace(/\n/g, '').replace(/<frame>/g, 'qqq:').replace(/<frame_end>/g, 'www:');
      var array = eee.split(" ");

      for (let i = 0; i < array.length; i++) {
        const element = array[i];

        // 開頭
        if (i == 2) {
          // 傳給next用
          skillname = array[i];

          // 第一個不用序號
          array[i] += (frameIndex != 1 ? frameIndex : '') + ' :{';
          frameIndex++;
        }

        // 忽略大標籤
        notwwwww(element, array, i, 'wpoint');
        notwwwww(element, array, i, 'bpoint');

        // 要的大標籤
        wwwww(element, array, i, 'itr');
        wwwww(element, array, i, 'opoint');
        wwwww(element, array, i, 'bdy');

        // 忽略屬性
        notabb(element, array, i, [
          'state',
          'dvz',
          'sound',
          'kind',
          'fall:',
          'rest',
          'bdefend',
          'effect',
          'hit_',
          'mp',
          'facing',
          'qqq',
          '\n',
        ], 2);

        notabb(element, array, i, [
          'catchingact',
          'caughtact',
        ], 3);

        // 要的屬性
        needabb(element, array, i, [
          'pic:',
          'wait:',
          'next:',
          'injury:',
          'x:',
          'y:',
          'w:',
          'h:',
        ]);

        // 替換屬性名
        changename(array, i, element, 'action:', 'name:');
        changename(array, i, element, 'oid:', 'frame:');

        // 座標類合併
        naasdasdme(element, array, i, 'move', 'dvx', 'dvy');
        naasdasdme(element, array, i, 'center', 'centerx', 'centery');


      }

      var eeeeeeeeeee = '';
      for (let i = 0; i < array.length; i++) {
        if (array[i] != '') eeeeeeeeeee += array[i] + ' ';
        if (i == array.length - 1 && array[i] == '') eeeeeeeeeee += '\n},';
      }



      document.getElementById("whereToPrint").innerHTML = eeeeeeeeeee;
    }


    // 替換大標籤
    function wwwww(element, array, i, tagname) {
      if (element == tagname + ':') {
        array[i] = '\n  ' + tagname + ': {';
      }
      else if (element == tagname + '_end:') {
        array[i] = '},';
      }
      else if (element == tagname + '_end:www:') {
        array[i] = '},\n},';
      }
    }


    // 忽略大標籤
    function notwwwww(element, array, i, tagname) {
      if (element == tagname + ':') ss = true;
      if (ss) array[i] = '';
      if (element == tagname + '_end:') ss = false;
      // if (element == tagname + '_end:www:qqq:') {
      //   ss = false;
      //   array[i] = '\n},\n';
      // }
    }

    // 需要屬性
    function needabb(element, array, i, ttt) {

      if (element == 'pic:') {
        var n = array[i + 1];
        var a = Math.floor(n / 70);
        var b = Math.floor((n - (a * 70)) / 10);
        var c = (n % 10);

        array[i] = `\n  pic:`;
        array[i + 1] = `['${a}', ${b}, ${c}]`;
      }

      else if (element == 'next:') {
        array[i + 1] = "'" + skillname + frameIndex + "'";
      }



      // 後面補逗點
      ttt.forEach(abname => {
        if (element == abname) array[i + 1] += ',';
      });
    }


    // 忽略屬性
    function notabb(element, array, i, ttt, sptime) {
      ttt.forEach(abname => {
        if (element.indexOf(abname) >= 0) {
          for (let j = 0; j < sptime; j++)
            array[i + j] = '';
        }
      });
    }

    // 更換屬性名
    function changename(array, i, element, name1, name2) {
      if (element == name1) {
        array[i] = name2;
        array[i + 1] += ','
      }
    }




    // 座標類
    function naasdasdme(element, array, i, n1, n2, n3) {

      if (ss) return;

      if (element == n2 + ':') {
        array.splice(i, 2, n1 + ':[' + array[i + 1]+',');
        // array[i] = `\n  pic:`;
        dd = true;
      }
      else if (element == n3 + ':') {
        array.splice(i, 2, '' + array[i + 1] + '],');
        dd = false;
      }

      // 如果沒有第二座標 補上0
      // if (array[i + 3] != n3 + ':') array[i + 1] += ', 0],';
    }

  </script>
</body>

</html>